<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Meta Shopping</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="style.css"/>
    <style>
      /* Brand button */
.btn-brand {
    background-color: #ff4d4f;
    color: #fff;
}
.btn-brand:hover {
    background-color: #e03e3f;
    color: #fff;
}

/* Hidden state */
.hidden { display: none !important; }

/* Wishlist toggle */
.wish-toggle.active { color: #e0245e !important; }

/* Footer */
.text-footer { color: #ccc !important; }
.text-copy { color: #aaa !important; }

/* Banner responsive */
#bannerCarousel img {
    height: 400px;
    object-fit: cover;
}
@media (max-width: 768px) {
    #bannerCarousel img { height: 260px; }
}
@media (max-width: 480px) {
    #bannerCarousel img { height: 200px; }
}

/* Ensure CSKH always on top */
#ms-chatbox,
#cskhPanel,
#cskhFab {
    z-index: 2000 !important;
}

        /* Custom styles for brand colors and elements */
        .btn-brand { background-color: #ff4d4f; color: #fff; }
        .btn-brand:hover { background-color: #e03e3f; color: #fff; }
        .hidden { display: none !important; }
        .wish-toggle.active { color: #e0245e !important; }
        .text-footer { color: #ccc !important; }
        .text-copy { color: #aaa !important; }
    </style>
</head>
<body>
<!-- HEADER: Navbar with brand, navigation links, search, account, wishlist, cart -->
<nav class="navbar sticky-top navbar-expand-md navbar-light bg-light border-bottom">
    <div class="container-fluid px-4">
        <!-- Brand Logo and Name -->
        <a class="navbar-brand d-flex align-items-center" href="/">
            <svg width="36" height="36" viewBox="0 0 36 36" aria-hidden="true">
                <defs>
                    <linearGradient id="g-meta" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stop-color="#ff6b6d"/>
                        <stop offset="100%" stop-color="#c71f1f"/>
                    </linearGradient>
                </defs>
                <rect x="2" y="2" width="32" height="32" rx="9" fill="url(#g-meta)"/>
                <path d="M10 25 L10 11 L14.5 18 L18 13 L21.5 18 L26 11 L26 25" fill="none" stroke="#fff" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="fw-bold" style="font-size:22px; color:#ff4d4f; margin-left:8px;">Meta Shopping</span>
        </a>
        <!-- Icons (Account, Wishlist, Cart) and Navbar Toggler -->
        <div class="d-flex align-items-center order-md-3">
            <span class="d-none d-md-inline text-muted small me-3">Xin ch√†o, User</span>
            <a href="#" class="me-3 icon position-relative" id="accountBtn" title="T√†i kho·∫£n">üë§</a>
            <a href="#" class="me-3 icon position-relative" id="favBtn" title="Y√™u th√≠ch" data-bs-toggle="offcanvas" data-bs-target="#favDrawer">
                ‚ù§Ô∏è <span id="favBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
            </a>
            <a href="#" class="me-3 icon position-relative" id="cartBtn" title="Gi·ªè h√†ng" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer">
                üõí <span id="cartBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <!-- Collapsible Nav Links and Search Form -->
        <div class="collapse navbar-collapse order-md-2" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
                <li class="nav-item"><a class="nav-link active" href="#">Trang Ch·ªß</a></li>
                <li class="nav-item"><a class="nav-link" href="#">S·∫£n Ph·∫©m</a></li>
                <li class="nav-item"><a class="nav-link" href="#">B·ªô S∆∞u T·∫≠p</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Tin T·ª©c</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Li√™n H·ªá</a></li>
            </ul>
            <form class="d-flex" role="search">
                <input class="form-control me-2" type="search" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." aria-label="T√¨m ki·∫øm">
                <button class="btn btn-outline-secondary" type="submit">üîç</button>
            </form>
        </div>
    </div>
</nav>

<!-- MAIN CONTENT -->
<main>
    <!-- Banner Carousel -->
    <section class="my-4 px-3">
        <div id="bannerCarousel"
             class="carousel slide carousel-fade rounded-4 shadow-sm w-100"
             data-bs-ride="carousel" data-bs-interval="2500"
             style="overflow:hidden;">

            <!-- Indicators -->
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="0" class="active" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
            </div>

            <!-- Slides -->
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="/images/banner-1.jpg" class="d-block w-100 rounded-4" alt="Banner 1"
                         style="height:400px; object-fit:cover;">
                    <div class="carousel-caption text-center">
                        <h5 class="fw-bold text-white">∆Øu ƒë√£i gi·ªØa m√πa ‚Äì Ti·∫øt ki·ªám t·ªõi 50%</h5>
                        <a href="#" class="btn btn-brand rounded-pill px-4">Mua ngay</a>
                    </div>
                </div>

                <div class="carousel-item">
                    <img src="/images/banner-2.jpg" class="d-block w-100 rounded-4" alt="Banner 2"
                         style="height:400px; object-fit:cover;">
                    <div class="carousel-caption text-center">
                        <h5 class="fw-bold text-white">B·ªô s∆∞u t·∫≠p m·ªõi ‚Äì Ch·∫•t v·∫£i cao c·∫•p</h5>
                        <a href="#" class="btn btn-brand rounded-pill px-4">Xem b·ªô s∆∞u t·∫≠p</a>
                    </div>
                </div>

                <div class="carousel-item">
                    <img src="/images/banner-3.jpg" class="d-block w-100 rounded-4" alt="Banner 3"
                         style="height:400px; object-fit:cover;">
                    <div class="carousel-caption text-center">
                        <h5 class="fw-bold text-white">Member Day ‚Äì ∆Øu ƒë√£i ri√™ng</h5>
                        <a href="#" class="btn btn-brand rounded-pill px-4">Tham gia ngay</a>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Products Section -->
    <section class="products py-4 px-4">
        <h2 class="text-center mb-4">S·∫£n ph·∫©m b√°n ch·∫°y</h2>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="productGrid">
            <!-- Product 1 -->
            <div class="product-card card h-100 text-center shadow-sm border-0 position-relative">
                <img src="/images/sanpham-1.jpg" class="card-img-top" alt="√Åo s∆° mi Aristino">
                <div class="card-body">
                    <h3 class="h6 card-title">√Åo s∆° mi Aristino</h3>
                    <p class="price text-danger fw-bold fs-6 mb-3">850,000ƒë</p>
                    <button class="btn btn-outline-secondary add-to-cart" data-id="ao-so-mi-aristino">Th√™m Gi·ªè h√†ng</button>
                    <button class="btn btn-brand rounded-pill ms-2 buy-now" data-id="ao-so-mi-aristino">Mua ngay</button>
                </div>
            </div>
            <!-- Product 2 -->
            <div class="product-card card h-100 text-center shadow-sm border-0 position-relative">
                <img src="/images/sanpham-2.jpg" class="card-img-top" alt="√Åo Polo Aristino">
                <div class="card-body">
                    <h3 class="h6 card-title">√Åo Polo Aristino</h3>
                    <p class="price text-danger fw-bold fs-6 mb-3">650,000ƒë</p>
                    <button class="btn btn-outline-secondary add-to-cart" data-id="ao-polo-aristino">Th√™m Gi·ªè h√†ng</button>
                    <button class="btn btn-brand rounded-pill ms-2 buy-now" data-id="ao-polo-aristino">Mua ngay</button>
                </div>
            </div>
            <!-- Product 3 -->
            <div class="product-card card h-100 text-center shadow-sm border-0 position-relative">
                <img src="/images/sanpham-3.jpg" class="card-img-top" alt="Qu·∫ßn √¢u Aristino">
                <div class="card-body">
                    <h3 class="h6 card-title">Qu·∫ßn √¢u Aristino</h3>
                    <p class="price text-danger fw-bold fs-6 mb-3">950,000ƒë</p>
                    <button class="btn btn-outline-secondary add-to-cart" data-id="quan-au-aristino">Th√™m Gi·ªè h√†ng</button>
                    <button class="btn btn-brand rounded-pill ms-2 buy-now" data-id="quan-au-aristino">Mua ngay</button>
                </div>
            </div>
            <!-- Product 4 (initially hidden, revealed by "Xem th√™m" button) -->
            <div class="product-card card h-100 text-center shadow-sm border-0 position-relative hidden">
                <img src="/images/sanpham-4.jpg" class="card-img-top" alt="√Åo Kho√°c Bomber">
                <div class="card-body">
                    <h3 class="h6 card-title">√Åo Kho√°c Bomber</h3>
                    <p class="price text-danger fw-bold fs-6 mb-3">1,200,000ƒë</p>
                    <button class="btn btn-outline-secondary add-to-cart" data-id="ao-khoac-bomber">Th√™m Gi·ªè h√†ng</button>
                    <button class="btn btn-brand rounded-pill ms-2 buy-now" data-id="ao-khoac-bomber">Mua ngay</button>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <button id="loadMore" class="btn btn-primary">Xem th√™m s·∫£n ph·∫©m</button>
        </div>
    </section>
</main>

<!-- FOOTER -->
<footer class="bg-dark text-light mt-5">
    <div class="container py-4 px-4">
        <div class="row">
            <div class="col-md-4 mb-3">
                <h4 class="text-white">Li√™n h·ªá</h4>
                <p class="text-footer mb-1">Hotline: 1800 8888</p>
                <p class="text-footer">Email: support@aristino.com</p>
            </div>
            <div class="col-md-4 mb-3">
                <h4 class="text-white">Ch√≠nh s√°ch</h4>
                <p class="text-footer mb-1">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</p>
                <p class="text-footer">Ch√≠nh s√°ch b·∫£o m·∫≠t</p>
            </div>
            <div class="col-md-4 mb-3">
                <h4 class="text-white">K·∫øt n·ªëi</h4>
                <p class="text-footer">Facebook | Instagram | YouTube</p>
            </div>
        </div>
        <p class="text-center text-copy mt-3 small">¬© 2025 Aristino. All rights reserved.</p>
    </div>
    <!-- Customer Support Floating Button -->
    <button class="btn btn-brand rounded-pill shadow-lg" id="cskhFab"
            style="position:fixed; right:20px; bottom:20px; z-index:2000;">
        üí¨ CSKH
    </button>
    <!-- Customer Support Quick Links Panel -->
    <div class="card shadow" id="cskhPanel" role="dialog" aria-modal="true" aria-labelledby="cskhTitle"
         style="position:fixed; right:20px; bottom:80px; width:280px; display:none; z-index:2000; padding:14px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong id="cskhTitle">H·ªó tr·ª£ kh√°ch h√†ng</strong>
            <button class="btn-close" id="cskhClose" aria-label="ƒê√≥ng"></button>
        </div>
        <a href="tel:18008888" class="d-block text-decoration-none text-dark mb-2">üìû G·ªçi: 1800 8888</a>
        <a href="mailto:support@aristino.com?subject=Ho%20tro%20don%20hang"
           class="d-block text-decoration-none text-dark mb-2">‚úâÔ∏è Email: support@aristino.com</a>
        <a href="https://zalo.me/0909123456" target="_blank" rel="noopener"
           class="d-block text-decoration-none text-dark mb-2">üí¨ Zalo: 0909 123 456</a>
        <a href="/contact" class="d-block text-decoration-none text-dark">üìù Form li√™n h·ªá</a>
    </div>
</footer>

<!-- Chat Box (Customer Support Chatbot) -->
<div id="ms-chatbox" class="card shadow" style="position:fixed; right:20px; bottom:90px; width:320px; max-width:92vw; display:none; z-index:1400;">
    <div class="card-header d-flex justify-content-between align-items-center p-2">
        <strong>Tr·ª£ l√Ω CSKH</strong>
        <button id="ms-chat-close" aria-label="ƒê√≥ng" class="btn-close"></button>
    </div>
    <div id="ms-chat-log" class="card-body" style="height:280px; overflow:auto; font-size:14px;">
        <div><b>Bot:</b> Xin ch√†o! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?</div>
    </div>
    <form id="ms-chat-form" class="d-flex p-2 border-top">
        <input id="ms-chat-input" class="form-control me-2" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
        <button type="submit" class="btn btn-brand">G·ª≠i</button>
    </form>
</div>

<!-- Cart Offcanvas (Shopping Cart Sidebar) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartTitle">
    <div class="offcanvas-header">
        <h5 id="cartTitle" class="offcanvas-title">Gi·ªè h√†ng</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="ƒê√≥ng"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <div id="cartList" class="flex-grow-1"><!-- Cart items will be injected here --></div>
        <div class="mt-3 border-top pt-3">
            <div class="d-flex justify-content-between mb-3">
                <span class="fw-bold">T·ªïng:</span>
                <span id="cartTotal" class="fw-bold">0ƒë</span>
            </div>
            <div class="d-flex">
                <button id="cartClear" class="btn btn-outline-secondary me-2">X√≥a gi·ªè</button>
                <button id="cartCheckout" class="btn btn-primary">Thanh to√°n</button>
            </div>
        </div>
    </div>
</div>

<!-- Favorites Offcanvas (Wishlist Sidebar) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="favDrawer" aria-labelledby="favTitle">
    <div class="offcanvas-header">
        <h5 id="favTitle" class="offcanvas-title">Y√™u th√≠ch</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="ƒê√≥ng"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <div id="favList" class="flex-grow-1"><!-- Favorite items will be injected here --></div>
        <div class="mt-3 border-top pt-3 text-end">
            <button id="favClear" class="btn btn-outline-secondary">X√≥a y√™u th√≠ch</button>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle JS (with Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS Scripts -->
<script>
    // Load more products
    document.getElementById("loadMore").addEventListener("click", function() {
        const hiddenItems = document.querySelectorAll(".product-card.hidden");
        for (let i = 0; i < 2 && i < hiddenItems.length; i++) {
            hiddenItems[i].classList.remove("hidden");
        }
        if (document.querySelectorAll(".product-card.hidden").length === 0) {
            this.style.display = "none";
        }
    });

    // CSKH Panel toggle
    (function() {
        const fab = document.getElementById('cskhFab');
        const panel = document.getElementById('cskhPanel');
        const closeBtn = document.getElementById('cskhClose');
        fab.addEventListener('click', () => {
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        });
        closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });
        document.addEventListener('click', (e) => {
            if (panel.style.display === 'block' && !panel.contains(e.target) && e.target !== fab) {
                panel.style.display = 'none';
            }
        });
    })();

    // CSKH Chat box
    (function() {
        const fab = document.getElementById('cskhFab');
        const chatbox = document.getElementById('ms-chatbox');
        const closeBtn = document.getElementById('ms-chat-close');
        const form = document.getElementById('ms-chat-form');
        const input = document.getElementById('ms-chat-input');
        const log = document.getElementById('ms-chat-log');

        fab.addEventListener('click', (e) => {
            e.preventDefault();
            chatbox.style.display = chatbox.style.display === 'block' ? 'none' : 'block';
            if (chatbox.style.display === 'block') input.focus();
        });
        closeBtn.addEventListener('click', () => { chatbox.style.display = 'none'; });
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;
            log.insertAdjacentHTML('beforeend', `<div><b>B·∫°n:</b> ${text}</div>`);
            input.value = '';
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, sessionId: crypto.randomUUID() })
                });
                const data = await response.json();
                log.insertAdjacentHTML('beforeend', `<div><b>Bot:</b> ${data.answer || '...'}</div>`);
                log.scrollTop = log.scrollHeight;
                if (data.handoff) {
                    log.insertAdjacentHTML('beforeend', `<div><button id="ms-handoff" class="btn btn-outline-secondary btn-sm mt-2">N·ªëi m√°y CSKH</button></div>`);
                    document.getElementById('ms-handoff').onclick = () => { window.location.href = '/contact'; };
                }
            } catch(err) {
                log.insertAdjacentHTML('beforeend', `<div><i>L·ªói m·∫°ng, th·ª≠ l·∫°i sau.</i></div>`);
            }
        });
    })();

    // === CART & WISHLIST ===
    (function() {
        const CART_KEY = 'meta_cart_v1';
        const FAV_KEY = 'meta_fav_v1';
        const cartListElem = document.getElementById('cartList');
        const cartTotalElem = document.getElementById('cartTotal');
        const cartBadge = document.getElementById('cartBadge');
        const favBadge = document.getElementById('favBadge');
        const favListElem = document.getElementById('favList');

        const toVND = n => (n || 0).toLocaleString('vi-VN') + 'ƒë';
        const parsePrice = t => parseInt((t || '').toString().replace(/[^\d]/g, '') || '0', 10);
        const slug = s => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || Math.random().toString(36).slice(2);

        function loadCart() { try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e) { return []; } }
        function saveCart(items) { localStorage.setItem(CART_KEY, JSON.stringify(items)); }
        function loadFav() { try { return JSON.parse(localStorage.getItem(FAV_KEY)) || []; } catch(e) { return []; } }
        function saveFav(items) { localStorage.setItem(FAV_KEY, JSON.stringify(items)); }

        function updateCartBadge() {
            const totalQty = loadCart().reduce((sum, item) => sum + (item.qty || 0), 0);
            cartBadge.textContent = totalQty;
        }
        function updateFavBadge() { favBadge.textContent = loadFav().length; }

        function renderCart() {
            const items = loadCart();
            cartListElem.innerHTML = items.length ? '' : '<p>Gi·ªè h√†ng tr·ªëng.</p>';
            let total = 0;
            items.forEach(item => {
                total += (item.price || 0) * (item.qty || 1);
                const row = document.createElement('div');
                row.className = 'd-flex align-items-center mb-3';
                row.dataset.id = item.id;
                row.innerHTML = `
        <img src="${item.image || 'https://via.placeholder.com/64'}" alt="${item.name}"
             style="width:64px; height:64px; object-fit:cover; border-radius:8px; margin-right:10px;">
        <div class="flex-grow-1">
          <div class="fw-semibold">${item.name}</div>
          <div class="text-danger fw-bold">${toVND(item.price)}</div>
          <div class="d-flex align-items-center mt-1">
            <button class="btn btn-sm btn-light px-2 py-1 me-2 dec" aria-label="Gi·∫£m">-</button>
            <span>${item.qty}</span>
            <button class="btn btn-sm btn-light px-2 py-1 ms-2 inc" aria-label="TƒÉng">+</button>
          </div>
        </div>
        <button class="btn btn-sm btn-outline-secondary remove-btn" title="X√≥a">üóëÔ∏è</button>`;
                cartListElem.appendChild(row);
            });
            cartTotalElem.textContent = toVND(total);
            updateCartBadge();
        }

        function renderFav() {
            const items = loadFav();
            favListElem.innerHTML = items.length ? '' : '<p>Ch∆∞a c√≥ s·∫£n ph·∫©m y√™u th√≠ch.</p>';
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'd-flex align-items-center mb-3';
                row.dataset.id = item.id;
                row.innerHTML = `
        <img src="${item.image || 'https://via.placeholder.com/64'}" alt="${item.name}"
             style="width:64px; height:64px; object-fit:cover; border-radius:8px; margin-right:10px;">
        <div class="flex-grow-1">
          <div class="fw-semibold">${item.name}</div>
          <div class="text-danger fw-bold">${toVND(item.price || 0)}</div>
          <button class="btn btn-outline-secondary btn-sm mt-2 add-from-fav">Th√™m v√†o gi·ªè</button>
        </div>
        <button class="btn btn-sm btn-outline-secondary remove-btn" title="B·ªè y√™u th√≠ch">üóëÔ∏è</button>`;
                favListElem.appendChild(row);
            });
            updateFavBadge();
        }

        function addToCart(product) {
            const items = loadCart();
            const idx = items.findIndex(it => it.id === product.id);
            if (idx >= 0) items[idx].qty += product.qty || 1;
            else items.push({ ...product, qty: product.qty || 1 });
            saveCart(items);
            renderCart();
        }

        function toggleFav(item) {
            const items = loadFav();
            const idx = items.findIndex(x => x.id === item.id);
            if (idx >= 0) items.splice(idx, 1); else items.push(item);
            saveFav(items);
            updateFavBadge();
        }

        renderCart();
        updateFavBadge();

        // Add-to-cart
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', e => {
                const cardElem = e.currentTarget.closest('.product-card');
                const name = cardElem.querySelector('h3')?.textContent.trim() || 'S·∫£n ph·∫©m';
                const price = parsePrice(cardElem.querySelector('.price')?.textContent);
                const image = cardElem.querySelector('img')?.src;
                const id = btn.dataset.id || slug(name);
                addToCart({ id, name, price, image, qty: 1 });
                btn.textContent = 'ƒê√£ th√™m ‚úì';
                setTimeout(() => { btn.textContent = 'Th√™m Gi·ªè h√†ng'; }, 1200);
            });
        });

        // Buy-now
        document.querySelectorAll('.buy-now').forEach(btn => {
            btn.addEventListener('click', e => {
                const cardElem = e.currentTarget.closest('.product-card');
                const name = cardElem.querySelector('h3')?.textContent.trim() || 'S·∫£n ph·∫©m';
                const price = parsePrice(cardElem.querySelector('.price')?.textContent);
                const image = cardElem.querySelector('img')?.src;
                const id = btn.dataset.id || slug(name);
                addToCart({ id, name, price, image, qty: 1 });
                bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartDrawer')).show();
            });
        });

        // Cart item events
        cartListElem.addEventListener('click', e => {
            const row = e.target.closest('div[data-id]');
            if (!row) return;
            const id = row.dataset.id;
            const items = loadCart();
            const item = items.find(x => x.id === id);
            if (!item) return;
            if (e.target.classList.contains('inc')) item.qty++;
            if (e.target.classList.contains('dec')) item.qty = Math.max(1, item.qty - 1);
            if (e.target.classList.contains('remove-btn')) items.splice(items.indexOf(item), 1);
            saveCart(items);
            renderCart();
        });

        document.getElementById('cartClear').addEventListener('click', () => { saveCart([]); renderCart(); });
        document.getElementById('cartCheckout').addEventListener('click', () => { alert('Demo checkout: Chuy·ªÉn t·ªõi trang /checkout.'); });

        favListElem.addEventListener('click', e => {
            const row = e.target.closest('div[data-id]');
            if (!row) return;
            const id = row.dataset.id;
            const favItems = loadFav();
            const favItem = favItems.find(x => x.id === id);
            if (!favItem) return;
            if (e.target.classList.contains('add-from-fav')) {
                addToCart({ ...favItem, qty: 1 });
                bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartDrawer')).show();
            }
            if (e.target.classList.contains('remove-btn')) {
                saveFav(favItems.filter(x => x.id !== id));
                renderFav();
                const heartBtn = document.querySelector(`.wish-toggle[data-id="${CSS.escape(id)}"]`);
                if (heartBtn) { heartBtn.classList.remove('active'); heartBtn.innerHTML = '‚ô°'; }
            }
        });

        document.getElementById('favClear').addEventListener('click', () => { saveFav([]); renderFav(); });

        function ensureHeartButtons() {
            document.querySelectorAll('.product-card').forEach(card => {
                if (card.querySelector('.wish-toggle')) return;
                const name = card.querySelector('h3')?.textContent.trim() || 'S·∫£n ph·∫©m';
                const price = parsePrice(card.querySelector('.price')?.textContent);
                const image = card.querySelector('img')?.src;
                const id = card.querySelector('.add-to-cart')?.dataset.id || slug(name);
                const isFav = loadFav().some(x => x.id === id);
                const btn = document.createElement('button');
                btn.className = 'wish-toggle btn btn-light shadow-sm position-absolute';
                btn.style.top = '10px';
                btn.style.right = '10px';
                btn.style.width = '34px';
                btn.style.height = '34px';
                btn.title = 'Th√™m v√†o y√™u th√≠ch';
                btn.dataset.id = id;
                btn.innerHTML = isFav ? '‚ù§' : '‚ô°';
                if (isFav) btn.classList.add('active');
                btn.addEventListener('click', () => {
                    const willAdd = !loadFav().some(x => x.id === id);
                    toggleFav({ id, name, price, image });
                    btn.classList.toggle('active', willAdd);
                    btn.innerHTML = willAdd ? '‚ù§' : '‚ô°';
                });
                card.appendChild(btn);
            });
        }
        ensureHeartButtons();

        const grid = document.getElementById('productGrid');
        if (grid) {
            const observer = new MutationObserver(() => ensureHeartButtons());
            observer.observe(grid, { childList: true });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('meta_open_cart') === '1') {
                localStorage.removeItem('meta_open_cart');
                bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartDrawer')).show();
            }
        });

        document.getElementById('favDrawer').addEventListener('show.bs.offcanvas', () => { renderFav(); });
    })();
</script>
</body>
</html>
